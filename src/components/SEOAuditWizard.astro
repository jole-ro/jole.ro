---
const { lang = "en" } = Astro.props;

const content = {
    en: {
        website: "Website URL",
        email: "Email Address",
        next: "Next Step",
        back: "Go Back",
        send: "Request Free Website Audit",
        sending: "Processing...",
        successTitle: "Audit Request Received!",
        successMessage:
            "Our team will perform a detailed manual audit of your website and send you the results via email within max. 2 business days.",
        error: "Something went wrong. Please try again.",
        privacyPath: "/privacy",
        privacy: "Privacy Policy",
        consent:
            "I agree to the processing of my personal data according to the",
    },
    hu: {
        website: "Weboldal címe",
        email: "Email cím",
        next: "Következő lépés",
        back: "Vissza",
        send: "Ingyenes Weboldal Audit Kérése",
        sending: "Folyamatban...",
        successTitle: "Audit kérés elküldve!",
        successMessage:
            "Csapatunk részletes manuális auditot végez, és az eredményeket 2 munkanapon belül e-mailben küldjük el.",
        error: "Hiba történt. Kérjük, próbálja újra.",
        privacyPath: "/hu/privacy",
        privacy: "adatkezelési tájékoztatóban",
        consent: "Hozzájárulok a személyes adataim kezeléséhez az",
    },
    ro: {
        website: "URL Website",
        email: "Adresă de Email",
        next: "Pasul Următor",
        back: "Pasul Anterior",
        send: "Solicită Audit Website Gratuit",
        sending: "Se procesează...",
        successTitle: "Solicitare Trimisă cu Succes!",
        successMessage:
            "Echipa noastră va efectua un audit manual detaliat și vă va trimite rezultatele prin e-mail în termen de 2 zile lucrătoare.",
        error: "A apărut o eroare. Vă rugăm să încercați din nou.",
        privacyPath: "/ro/privacy",
        privacy: "politica de confidențialitate",
        consent: "Sunt de acord cu prelucrarea datelor mele personale conform",
    },
};

const t = content[lang as keyof typeof content] || content.en;
---

<div
    class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 min-h-[400px] flex flex-col justify-center w-full"
>
    <form class="audit-wizard-form-comp space-y-6">
        <!-- Step 1: Website -->
        <div class="wizard-step step-1">
            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                    >{t.website}</label
                >
                <input
                    type="text"
                    name="website"
                    placeholder="your-website.com"
                    class="wizard-website w-full px-4 py-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-shadow text-lg"
                    required
                />
            </div>
            <button
                type="button"
                class="next-to-step-2 w-full bg-primary text-white py-4 rounded-xl hover:bg-primary-hover cursor-pointer font-semibold shadow-lg shadow-primary/20 transition-all hover:-translate-y-1 active:scale-95"
            >
                {t.next}
            </button>
        </div>

        <!-- Step 2: Email & Consent -->
        <div class="wizard-step step-2 hidden">
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                    >{t.email}</label
                >
                <input
                    type="email"
                    name="email"
                    placeholder="your@email.com"
                    class="wizard-email w-full px-4 py-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-shadow text-lg"
                    required
                />
            </div>

            <div class="mb-8 flex items-start gap-3">
                <input
                    type="checkbox"
                    name="consent"
                    value="true"
                    required
                    class="gdpr-consent-wizard mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary cursor-pointer"
                />
                <label class="text-sm text-gray-600 leading-tight">
                    {t.consent}
                    <a
                        href={t.privacyPath}
                        class="text-primary hover:underline font-medium"
                        >{t.privacy}</a
                    >.
                </label>
            </div>

            <div class="flex gap-4">
                <button
                    type="button"
                    class="back-to-step-1 flex-1 bg-gray-50 text-gray-600 py-4 rounded-xl hover:bg-gray-100 cursor-pointer font-semibold transition-all"
                >
                    {t.back}
                </button>
                <button
                    type="submit"
                    class="submit-wizard flex-[2] bg-primary text-white py-4 rounded-xl hover:bg-primary-hover cursor-pointer font-semibold shadow-lg shadow-primary/20 transition-all hover:-translate-y-1 active:scale-95 disabled:opacity-50"
                >
                    <span class="submit-wizard-text">{t.send}</span>
                </button>
            </div>
        </div>

        <!-- Success Step -->
        <div class="wizard-step step-success hidden text-center py-8">
            <div
                class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl"
            >
                <i class="ri-checkbox-circle-line"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">
                {t.successTitle}
            </h3>
            <p class="text-gray-600 text-lg leading-relaxed">
                {t.successMessage}
            </p>
        </div>
    </form>
</div>

<script>
    function setupWizard(form: HTMLFormElement) {
        const step1 = form.querySelector(".step-1") as HTMLElement;
        const step2 = form.querySelector(".step-2") as HTMLElement;
        const stepSuccess = form.querySelector(".step-success") as HTMLElement;

        const nextBtn = form.querySelector(
            ".next-to-step-2",
        ) as HTMLButtonElement;
        const backBtn = form.querySelector(
            ".back-to-step-1",
        ) as HTMLButtonElement;
        const submitBtn = form.querySelector(
            ".submit-wizard",
        ) as HTMLButtonElement;
        const submitText = form.querySelector(".submit-wizard-text");

        const websiteInput = form.querySelector(
            ".wizard-website",
        ) as HTMLInputElement;

        if (nextBtn) {
            nextBtn.addEventListener("click", () => {
                const urlValue = websiteInput.value.trim();
                if (urlValue && urlValue.includes(".")) {
                    step1.classList.add("hidden");
                    step2.classList.remove("hidden");
                } else {
                    const lang = document.documentElement.lang;
                    websiteInput.setCustomValidity(
                        lang === "hu"
                            ? "Kérjük, adjon meg egy érvényes weboldal címet!"
                            : lang === "ro"
                              ? "Vă rugăm să introduceți o adresă de website validă!"
                              : "Please enter a valid website address!",
                    );
                    websiteInput.reportValidity();
                    websiteInput.setCustomValidity("");
                }
            });
        }

        if (backBtn) {
            backBtn.addEventListener("click", () => {
                step2.classList.add("hidden");
                step1.classList.remove("hidden");
            });
        }

        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            submitBtn.disabled = true;
            const originalText = submitText?.textContent;
            if (submitText) {
                const lang = document.documentElement.lang;
                submitText.textContent =
                    lang === "hu"
                        ? "Folyamatban..."
                        : lang === "ro"
                          ? "Se procesează..."
                          : "Processing...";
            }

            try {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                const response = await fetch(
                    "https://submit-form.com/41PA1XYWP",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Accept: "application/json",
                        },
                        body: JSON.stringify({
                            ...data,
                            _subject: `WIZARD: New Website Audit Request - ${data.website}`,
                            source: "Website Audit Wizard Component",
                        }),
                    },
                );

                if (response.ok) {
                    step2.classList.add("hidden");
                    stepSuccess.classList.remove("hidden");
                } else {
                    throw new Error("Submission failed");
                }
            } catch (error) {
                const lang = document.documentElement.lang;
                alert(
                    lang === "hu"
                        ? "Hiba történt. Kérjük, próbálja újra."
                        : lang === "ro"
                          ? "A apărut o eroare. Vă rugăm să încercați din nou."
                          : "Something went wrong. Please try again.",
                );
                console.error("Form submission error:", error);
            } finally {
                submitBtn.disabled = false;
                if (submitText && originalText)
                    submitText.textContent = originalText;
            }
        });
    }

    // Initialize all wizards on the page
    document.querySelectorAll(".audit-wizard-form-comp").forEach((form) => {
        setupWizard(form as HTMLFormElement);
    });
</script>
